name: è‡ªåŠ¨æ„å»º qwen-code å¯æ‰§è¡Œæ–‡ä»¶

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´æ—©ä¸Š 8 ç‚¹ï¼ˆUTC 0 ç‚¹ï¼‰è¿è¡Œ
    - cron: '0 0 * * *'
  workflow_dispatch: # æ”¯æŒæ‰‹åŠ¨è§¦å‘
    inputs:
      skip-check:
        description: 'è·³è¿‡ç‰ˆæœ¬æ£€æŸ¥ï¼Œå¼ºåˆ¶æ„å»º'
        required: false
        type: boolean
        default: false
#   push:
#     branches: [ main ] # å½“ä¸»åˆ†æ”¯æœ‰æ¨é€æ—¶ä¹Ÿè§¦å‘

# æ·»åŠ æƒé™è®¾ç½®
permissions:
  contents: write  # å…è®¸åˆ›å»º release å’Œå†™å…¥å†…å®¹

jobs:
  check-updates:
    runs-on: ubuntu-latest
    outputs:
      should-build: ${{ steps.check.outputs.should-build }}
      latest-commit: ${{ steps.check.outputs.latest-commit }}
    steps:
      - name: æ£€å‡ºå½“å‰ä»“åº“
        uses: actions/checkout@v4
        
      - name: æ£€æŸ¥ä¸Šæ¸¸ä»“åº“æ˜¯å¦æœ‰æ›´æ–°
        id: check
        run: |
          # è·å–ä¸Šæ¸¸æœ€æ–° commit
          LATEST_COMMIT=$(curl -s https://api.github.com/repos/QwenLM/qwen-code/commits/main | jq -r '.sha[:7]')
          echo "latest-commit=$LATEST_COMMIT" >> $GITHUB_OUTPUT
          
          # å¦‚æœæ‰‹åŠ¨è§¦å‘ä¸”é€‰æ‹©è·³è¿‡æ£€æŸ¥ï¼Œç›´æ¥æ„å»º
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ github.event.inputs.skip-check }}" == "true" ]]; then
            echo "æ‰‹åŠ¨è§¦å‘ä¸”é€‰æ‹©è·³è¿‡æ£€æŸ¥ï¼Œå¼ºåˆ¶æ„å»ºç‰ˆæœ¬ $LATEST_COMMIT"
            echo "should-build=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # è·å–å½“å‰ä»“åº“ä¿¡æ¯
          REPO_OWNER=$(echo $GITHUB_REPOSITORY | cut -d'/' -f1)
          REPO_NAME=$(echo $GITHUB_REPOSITORY | cut -d'/' -f2)
          
          echo "æ£€æŸ¥ä»“åº“: $GITHUB_REPOSITORY"
          echo "æ£€æŸ¥ release: auto-$LATEST_COMMIT"
          
          # æ£€æŸ¥æ˜¯å¦å·²ç»æ„å»ºè¿‡è¿™ä¸ªç‰ˆæœ¬
          # ä½¿ç”¨ API æ£€æŸ¥æ›´å¯é 
          if curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/$GITHUB_REPOSITORY/releases/tags/auto-$LATEST_COMMIT" | \
            jq -e '.id' > /dev/null 2>&1; then
            echo "ç‰ˆæœ¬ auto-$LATEST_COMMIT å·²å­˜åœ¨ï¼Œè·³è¿‡æ„å»º"
            echo "should-build=false" >> $GITHUB_OUTPUT
          else
            echo "å‘ç°æ–°ç‰ˆæœ¬ $LATEST_COMMITï¼Œå¼€å§‹æ„å»º"
            echo "should-build=true" >> $GITHUB_OUTPUT
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build:
    needs: check-updates
    if: needs.check-updates.outputs.should-build == 'true'
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: linux-x64
            binary-name: qwen
            archive-ext: tar.gz
          - os: windows-latest
            target: windows-x64
            binary-name: qwen.exe
            archive-ext: zip
          - os: macos-13  # Intel macOS
            target: macos-x64
            binary-name: qwen
            archive-ext: tar.gz
          - os: macos-latest  # Apple Silicon macOS
            target: macos-arm64
            binary-name: qwen
            archive-ext: tar.gz
    
    runs-on: ${{ matrix.os }}
    
    steps:
      - name: å…‹éš†ä¸Šæ¸¸ä»“åº“
        uses: actions/checkout@v4
        with:
          repository: QwenLM/qwen-code
          ref: main
          
      - name: å®‰è£… Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest
      
      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: å®‰è£…ä¾èµ–
        run: npm install
    
      - name: è·å–å›¾æ ‡æ–‡ä»¶
        shell: bash
        run: |
          # ä»ä½ çš„ä»“åº“è·å–å›¾æ ‡æ–‡ä»¶
          curl -s https://raw.githubusercontent.com/${{ github.repository }}/main/qwen.ico -o qwen.ico || echo "å›¾æ ‡æ–‡ä»¶ä¸å­˜åœ¨ï¼Œå°†ä¸ä½¿ç”¨å›¾æ ‡"
          if [ -f "qwen.ico" ]; then
            echo "âœ… æˆåŠŸè·å–å›¾æ ‡æ–‡ä»¶"
            ls -la qwen.ico
          else
            echo "âš ï¸ æœªæ‰¾åˆ°å›¾æ ‡æ–‡ä»¶ï¼ŒWindows ç‰ˆæœ¬å°†ä½¿ç”¨é»˜è®¤å›¾æ ‡"
          fi
        
      - name: æ‰¾åˆ°å…¥å£æ–‡ä»¶
        id: entry
        shell: bash
        run: |
          # æŸ¥æ‰¾å¯èƒ½çš„å…¥å£æ–‡ä»¶
          if [ -f "bundle/gemini.js" ]; then
            echo "entry=bundle/gemini.js" >> $GITHUB_OUTPUT
            echo "æ‰¾åˆ°å…¥å£æ–‡ä»¶: bundle/gemini.js"
          else
            # ä» package.json è¯»å– main æˆ– bin
            if [ -f "package.json" ]; then
              MAIN=$(node -e "
                const pkg = require('./package.json');
                if (pkg.bin) {
                  if (typeof pkg.bin === 'string') {
                    console.log(pkg.bin);
                  } else {
                    console.log(Object.values(pkg.bin)[0]);
                  }
                } else {
                  console.log(pkg.main || 'index.js');
                }
              " 2>/dev/null || echo "index.js")
              echo "entry=$MAIN" >> $GITHUB_OUTPUT
              echo "ä» package.json è¯»å–å…¥å£æ–‡ä»¶: $MAIN"
            else
              echo "entry=index.js" >> $GITHUB_OUTPUT
              echo "ä½¿ç”¨é»˜è®¤å…¥å£æ–‡ä»¶: index.js"
            fi
          fi
        
      - name: ç¼–è¯‘å¯æ‰§è¡Œæ–‡ä»¶
        shell: bash
        run: |
          echo "ç¼–è¯‘å…¥å£æ–‡ä»¶: ${{ steps.entry.outputs.entry }}"
          # æ ¹æ®å¹³å°å†³å®šæ˜¯å¦ä½¿ç”¨å›¾æ ‡å‚æ•°
          if [[ "${{ matrix.os }}" == "windows-latest" ]] && [ -f "qwen.ico" ]; then
            echo "åœ¨ Windows ä¸Šä½¿ç”¨å›¾æ ‡æ–‡ä»¶"
            bun build ${{ steps.entry.outputs.entry }} --compile --windows-icon=qwen.ico --outfile ${{ matrix.binary-name }}
          else
            bun build ${{ steps.entry.outputs.entry }} --compile --outfile ${{ matrix.binary-name }}
          fi
          
      - name: éªŒè¯å¯æ‰§è¡Œæ–‡ä»¶
        shell: bash
        run: |
          EXECUTABLE="${{ matrix.binary-name }}"
          echo "éªŒè¯å¯æ‰§è¡Œæ–‡ä»¶: $EXECUTABLE"
          
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ ! -f "$EXECUTABLE" ]; then
            echo "âŒ å¯æ‰§è¡Œæ–‡ä»¶ä¸å­˜åœ¨: $EXECUTABLE"
            exit 1
          fi
          
          # æ£€æŸ¥æ–‡ä»¶å¤§å°
          FILE_SIZE=$(stat -c%s "$EXECUTABLE" 2>/dev/null || stat -f%z "$EXECUTABLE" 2>/dev/null || wc -c < "$EXECUTABLE")
          echo "æ–‡ä»¶å¤§å°: $FILE_SIZE bytes"
          
          if [ "$FILE_SIZE" -lt 1000000 ]; then
            echo "âš ï¸ è­¦å‘Š: æ–‡ä»¶å¤§å°å¯èƒ½å¼‚å¸¸å°"
          fi
          
          # å°è¯•è¿è¡Œç‰ˆæœ¬æ£€æŸ¥ï¼ˆå¯èƒ½å¤±è´¥ï¼Œä½†ä¸å½±å“æ„å»ºï¼‰
          echo "å°è¯•è¿è¡Œç‰ˆæœ¬æ£€æŸ¥..."
          if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
            ./"$EXECUTABLE" --version 2>/dev/null || ./"$EXECUTABLE" -v 2>/dev/null || echo "ç‰ˆæœ¬æ£€æŸ¥å¤±è´¥ï¼Œä½†æ–‡ä»¶å·²ç”Ÿæˆ"
          else
            ./"$EXECUTABLE" --version 2>/dev/null || ./"$EXECUTABLE" -v 2>/dev/null || echo "ç‰ˆæœ¬æ£€æŸ¥å¤±è´¥ï¼Œä½†æ–‡ä»¶å·²ç”Ÿæˆ"
          fi
          
          echo "âœ… å¯æ‰§è¡Œæ–‡ä»¶éªŒè¯å®Œæˆ"
      
      - name: åˆ›å»ºå‹ç¼©åŒ…
        shell: bash
        run: |
          ARCHIVE_NAME="qwen-${{ matrix.target }}.${{ matrix.archive-ext }}"
          echo "åˆ›å»ºå‹ç¼©åŒ…: $ARCHIVE_NAME"
          
          if [[ "${{ matrix.archive-ext }}" == "zip" ]]; then
            # Windows ä½¿ç”¨ zip
            7z a "$ARCHIVE_NAME" "${{ matrix.binary-name }}"
          else
            # Unix ç³»ç»Ÿä½¿ç”¨ tar.gz
            tar -czf "$ARCHIVE_NAME" "${{ matrix.binary-name }}"
          fi
          
          # éªŒè¯å‹ç¼©åŒ…
          if [ ! -f "$ARCHIVE_NAME" ]; then
            echo "âŒ å‹ç¼©åŒ…åˆ›å»ºå¤±è´¥"
            exit 1
          fi
          
          echo "âœ… å‹ç¼©åŒ…åˆ›å»ºæˆåŠŸ"
        
      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: qwen-${{ matrix.target }}
          path: qwen-${{ matrix.target }}.${{ matrix.archive-ext }}
          retention-days: 30

  release:
    needs: [check-updates, build]
    runs-on: ubuntu-latest
    if: needs.check-updates.outputs.should-build == 'true'
    
    steps:
      - name: è®¾ç½®ä»“åº“
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: è·å–è®¸å¯è¯æ–‡ä»¶
        run: |
          # ä»ä¸Šæ¸¸ä»“åº“è·å–è®¸å¯è¯æ–‡ä»¶
          curl -s https://raw.githubusercontent.com/QwenLM/qwen-code/main/LICENSE -o LICENSE
          curl -s https://raw.githubusercontent.com/QwenLM/qwen-code/main/NOTICE -o NOTICE 2>/dev/null || echo "NOTICE æ–‡ä»¶ä¸å­˜åœ¨"
          curl -s https://raw.githubusercontent.com/QwenLM/qwen-code/main/COPYRIGHT -o COPYRIGHT 2>/dev/null || echo "COPYRIGHT æ–‡ä»¶ä¸å­˜åœ¨"
          
      - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        
      - name: å‡†å¤‡å‘å¸ƒæ–‡ä»¶
        shell: bash
        run: |
          # å°†æ‰€æœ‰å‹ç¼©åŒ…ç§»åˆ°å½“å‰ç›®å½•
          mv qwen-linux-x64/qwen-linux-x64.tar.gz . || true
          mv qwen-windows-x64/qwen-windows-x64.zip . || true
          mv qwen-macos-x64/qwen-macos-x64.tar.gz . || true
          mv qwen-macos-arm64/qwen-macos-arm64.tar.gz . || true
          
          # åˆ—å‡ºæ‰€æœ‰æ–‡ä»¶
          echo "å‡†å¤‡å‘å¸ƒçš„æ–‡ä»¶ï¼š"
          ls -la *.tar.gz *.zip LICENSE* NOTICE* COPYRIGHT* 2>/dev/null || true
          
      - name: åˆ›å»ºå‘å¸ƒ
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          COMMIT_SHA="${{ needs.check-updates.outputs.latest-commit }}"
          RELEASE_TAG="auto-$COMMIT_SHA"
          RELEASE_NAME="è‡ªåŠ¨æ„å»º - $COMMIT_SHA ($(date '+%Y-%m-%d'))"
          
          # å¦‚æœæ˜¯å¼ºåˆ¶æ„å»ºï¼Œå…ˆå°è¯•åˆ é™¤å·²å­˜åœ¨çš„ release
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ github.event.inputs.skip-check }}" == "true" ]]; then
            echo "å¼ºåˆ¶æ„å»ºæ¨¡å¼ï¼Œæ£€æŸ¥å¹¶åˆ é™¤å·²å­˜åœ¨çš„ release..."
            if gh release view "$RELEASE_TAG" >/dev/null 2>&1; then
              echo "åˆ é™¤å·²å­˜åœ¨çš„ release: $RELEASE_TAG"
              gh release delete "$RELEASE_TAG" -y
            fi
          fi
          
          # å‡†å¤‡å‘å¸ƒæ–‡ä»¶åˆ—è¡¨
          RELEASE_FILES=""
          
          # æ·»åŠ å‹ç¼©åŒ…
          [ -f "qwen-linux-x64.tar.gz" ] && RELEASE_FILES="$RELEASE_FILES qwen-linux-x64.tar.gz"
          [ -f "qwen-windows-x64.zip" ] && RELEASE_FILES="$RELEASE_FILES qwen-windows-x64.zip"
          [ -f "qwen-macos-x64.tar.gz" ] && RELEASE_FILES="$RELEASE_FILES qwen-macos-x64.tar.gz"
          [ -f "qwen-macos-arm64.tar.gz" ] && RELEASE_FILES="$RELEASE_FILES qwen-macos-arm64.tar.gz"
          
          # åˆ›å»º release
          gh release create "$RELEASE_TAG" \
            --title "$RELEASE_NAME" \
            --notes "åŸºäº QwenLM/qwen-code@$COMMIT_SHA çš„è‡ªåŠ¨æ„å»ºç‰ˆæœ¬
          
          $([[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ github.event.inputs.skip-check }}" == "true" ]] && echo "ğŸ”„ **å¼ºåˆ¶é‡æ–°æ„å»º**")

          ğŸ“¦ **åŒ…å«å¹³å°:**
          - Linux x64: \`qwen-linux-x64.tar.gz\`
          - Windows x64: \`qwen-windows-x64.zip\`
          - macOS x64 (Intel): \`qwen-macos-x64.tar.gz\`
          - macOS ARM64 (Apple Silicon): \`qwen-macos-arm64.tar.gz\`
          
          ğŸš€ **ä½¿ç”¨æ–¹æ³•:**
          1. ä¸‹è½½å¯¹åº”å¹³å°çš„å‹ç¼©åŒ…
          2. è§£å‹åå¾—åˆ° \`qwen\` æˆ– \`qwen.exe\` å¯æ‰§è¡Œæ–‡ä»¶
          3. è®¾ç½®ç¯å¢ƒå˜é‡: \`OPENAI_API_KEY\`, \`OPENAI_BASE_URL\`, \`OPENAI_MODEL\`
          4. ç›´æ¥è¿è¡Œ: \`./qwen\` (Unix) æˆ– \`qwen.exe\` (Windows)
          
          âš–ï¸ **è®¸å¯è¯è¯´æ˜:**
          - åŸå§‹é¡¹ç›®è®¸å¯è¯: Apache License 2.0
          - åŸå§‹é¡¹ç›®åœ°å€: https://github.com/QwenLM/qwen-code
          - ç‰ˆæƒå½’å±: Qwen Team, Alibaba Cloud
          
          âš ï¸ **é‡è¦å£°æ˜:** 
          - è¿™æ˜¯**éå®˜æ–¹**æ„å»ºç‰ˆæœ¬ï¼Œä¸ä»£è¡¨åŸä½œè€…ç«‹åœº
          - å¦‚é‡é—®é¢˜è¯·ä¼˜å…ˆä½¿ç”¨å®˜æ–¹ç‰ˆæœ¬
          - ä½¿ç”¨æ—¶è¯·éµå®ˆ Apache License 2.0 æ¡æ¬¾" \
            $RELEASE_FILES

  notify:
    needs: [check-updates, build, release]
    runs-on: ubuntu-latest
    if: always() && needs.check-updates.outputs.should-build == 'true'
    
    steps:
      - name: é€šçŸ¥æ„å»ºç»“æœ
        run: |
          if [ "${{ needs.release.result }}" = "success" ]; then
            echo "âœ… æ„å»ºæˆåŠŸï¼æ–°ç‰ˆæœ¬å·²å‘å¸ƒ: auto-${{ needs.check-updates.outputs.latest-commit }}"
          else
            echo "âŒ æ„å»ºå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
          fi