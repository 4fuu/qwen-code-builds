# .github/workflows/auto-build.yml
name: è‡ªåŠ¨æ„å»º qwen-code å¯æ‰§è¡Œæ–‡ä»¶

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´æ—©ä¸Š 8 ç‚¹ï¼ˆUTC 0 ç‚¹ï¼‰è¿è¡Œ
    - cron: '0 0 * * *'
  workflow_dispatch: # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main ] # å½“ä¸»åˆ†æ”¯æœ‰æ¨é€æ—¶ä¹Ÿè§¦å‘

jobs:
  check-updates:
    runs-on: ubuntu-latest
    outputs:
      should-build: ${{ steps.check.outputs.should-build }}
      latest-commit: ${{ steps.check.outputs.latest-commit }}
    steps:
      - name: æ£€æŸ¥ä¸Šæ¸¸ä»“åº“æ˜¯å¦æœ‰æ›´æ–°
        id: check
        run: |
          # è·å–ä¸Šæ¸¸æœ€æ–° commit
          LATEST_COMMIT=$(curl -s https://api.github.com/repos/QwenLM/qwen-code/commits/main | jq -r '.sha[:7]')
          echo "latest-commit=$LATEST_COMMIT" >> $GITHUB_OUTPUT
          
          # æ£€æŸ¥æ˜¯å¦å·²ç»æ„å»ºè¿‡è¿™ä¸ªç‰ˆæœ¬
          if gh release view "auto-$LATEST_COMMIT" >/dev/null 2>&1; then
            echo "ç‰ˆæœ¬ $LATEST_COMMIT å·²å­˜åœ¨ï¼Œè·³è¿‡æ„å»º"
            echo "should-build=false" >> $GITHUB_OUTPUT
          else
            echo "å‘ç°æ–°ç‰ˆæœ¬ $LATEST_COMMITï¼Œå¼€å§‹æ„å»º"
            echo "should-build=true" >> $GITHUB_OUTPUT
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build:
    needs: check-updates
    if: needs.check-updates.outputs.should-build == 'true'
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: linux-x64
            ext: ''
          - os: windows-latest
            target: windows-x64
            ext: '.exe'
          - os: macos-13  # Intel macOS
            target: macos-x64
            ext: ''
          - os: macos-latest  # Apple Silicon macOS (æœ€æ–°)
            target: macos-arm64
            ext: ''
    
    runs-on: ${{ matrix.os }}
    
    steps:
      - name: å…‹éš†ä¸Šæ¸¸ä»“åº“
        uses: actions/checkout@v4
        with:
          repository: QwenLM/qwen-code
          ref: main
          
      - name: å®‰è£… Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest
      
      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: å®‰è£…ä¾èµ–
        run: npm install
        
      - name: æ‰¾åˆ°å…¥å£æ–‡ä»¶
        id: entry
        shell: bash
        run: |
          # æŸ¥æ‰¾å¯èƒ½çš„å…¥å£æ–‡ä»¶
          if [ -f "bundle/gemini.js" ]; then
            echo "entry=bundle/gemini.js" >> $GITHUB_OUTPUT
            echo "æ‰¾åˆ°å…¥å£æ–‡ä»¶: bundle/gemini.js"
          else
            # ä» package.json è¯»å– main æˆ– bin
            if [ -f "package.json" ]; then
              MAIN=$(node -e "
                const pkg = require('./package.json');
                if (pkg.bin) {
                  if (typeof pkg.bin === 'string') {
                    console.log(pkg.bin);
                  } else {
                    console.log(Object.values(pkg.bin)[0]);
                  }
                } else {
                  console.log(pkg.main || 'index.js');
                }
              " 2>/dev/null || echo "index.js")
              echo "entry=$MAIN" >> $GITHUB_OUTPUT
              echo "ä» package.json è¯»å–å…¥å£æ–‡ä»¶: $MAIN"
            else
              echo "entry=index.js" >> $GITHUB_OUTPUT
              echo "ä½¿ç”¨é»˜è®¤å…¥å£æ–‡ä»¶: index.js"
            fi
          fi
        
      - name: ä½¿ç”¨ Bun ç¼–è¯‘å¯æ‰§è¡Œæ–‡ä»¶
        run: |
          echo "ç¼–è¯‘å…¥å£æ–‡ä»¶: ${{ steps.entry.outputs.entry }}"
          bun build ${{ steps.entry.outputs.entry }} --compile --outfile qwen-code-${{ matrix.target }}${{ matrix.ext }}
          
      - name: éªŒè¯å¯æ‰§è¡Œæ–‡ä»¶
        shell: bash
        run: |
          EXECUTABLE="qwen-code-${{ matrix.target }}${{ matrix.ext }}"
          echo "éªŒè¯å¯æ‰§è¡Œæ–‡ä»¶: $EXECUTABLE"
          
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ ! -f "$EXECUTABLE" ]; then
            echo "âŒ å¯æ‰§è¡Œæ–‡ä»¶ä¸å­˜åœ¨: $EXECUTABLE"
            exit 1
          fi
          
          # æ£€æŸ¥æ–‡ä»¶å¤§å°
          FILE_SIZE=$(stat -c%s "$EXECUTABLE" 2>/dev/null || stat -f%z "$EXECUTABLE" 2>/dev/null || wc -c < "$EXECUTABLE")
          echo "æ–‡ä»¶å¤§å°: $FILE_SIZE bytes"
          
          if [ "$FILE_SIZE" -lt 1000000 ]; then
            echo "âš ï¸ è­¦å‘Š: æ–‡ä»¶å¤§å°å¯èƒ½å¼‚å¸¸å°"
          fi
          
          # å°è¯•è¿è¡Œç‰ˆæœ¬æ£€æŸ¥ï¼ˆå¯èƒ½å¤±è´¥ï¼Œä½†ä¸å½±å“æ„å»ºï¼‰
          echo "å°è¯•è¿è¡Œç‰ˆæœ¬æ£€æŸ¥..."
          if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
            ./"$EXECUTABLE" --version 2>/dev/null || ./"$EXECUTABLE" -v 2>/dev/null || echo "ç‰ˆæœ¬æ£€æŸ¥å¤±è´¥ï¼Œä½†æ–‡ä»¶å·²ç”Ÿæˆ"
          else
            ./"$EXECUTABLE" --version 2>/dev/null || ./"$EXECUTABLE" -v 2>/dev/null || echo "ç‰ˆæœ¬æ£€æŸ¥å¤±è´¥ï¼Œä½†æ–‡ä»¶å·²ç”Ÿæˆ"
          fi
          
          echo "âœ… å¯æ‰§è¡Œæ–‡ä»¶éªŒè¯å®Œæˆ"
        
      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: qwen-code-${{ matrix.target }}
          path: qwen-code-${{ matrix.target }}${{ matrix.ext }}
          retention-days: 30

  release:
    needs: [check-updates, build]
    runs-on: ubuntu-latest
    if: needs.check-updates.outputs.should-build == 'true'
    
    steps:
      - name: è·å–è®¸å¯è¯æ–‡ä»¶
        run: |
          # ä»ä¸Šæ¸¸ä»“åº“è·å–è®¸å¯è¯æ–‡ä»¶
          curl -s https://raw.githubusercontent.com/QwenLM/qwen-code/main/LICENSE -o LICENSE
          curl -s https://raw.githubusercontent.com/QwenLM/qwen-code/main/NOTICE -o NOTICE 2>/dev/null || echo "NOTICE æ–‡ä»¶ä¸å­˜åœ¨"
          curl -s https://raw.githubusercontent.com/QwenLM/qwen-code/main/COPYRIGHT -o COPYRIGHT 2>/dev/null || echo "COPYRIGHT æ–‡ä»¶ä¸å­˜åœ¨"
          
      - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        
      - name: åˆ›å»ºå‘å¸ƒ
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          COMMIT_SHA="${{ needs.check-updates.outputs.latest-commit }}"
          RELEASE_TAG="auto-$COMMIT_SHA"
          RELEASE_NAME="è‡ªåŠ¨æ„å»º - $COMMIT_SHA ($(date '+%Y-%m-%d'))"
          
          # å‡†å¤‡å‘å¸ƒæ–‡ä»¶åˆ—è¡¨
          RELEASE_FILES=""
          
          # æ·»åŠ è®¸å¯è¯æ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          [ -f "LICENSE" ] && RELEASE_FILES="$RELEASE_FILES LICENSE"
          [ -f "NOTICE" ] && RELEASE_FILES="$RELEASE_FILES NOTICE"
          [ -f "COPYRIGHT" ] && RELEASE_FILES="$RELEASE_FILES COPYRIGHT"
          
          # æ·»åŠ å¯æ‰§è¡Œæ–‡ä»¶
          RELEASE_FILES="$RELEASE_FILES qwen-code-linux-x64/qwen-code-linux-x64"
          RELEASE_FILES="$RELEASE_FILES qwen-code-windows-x64/qwen-code-windows-x64.exe"
          RELEASE_FILES="$RELEASE_FILES qwen-code-macos-x64/qwen-code-macos-x64"
          RELEASE_FILES="$RELEASE_FILES qwen-code-macos-arm64/qwen-code-macos-arm64"
          
          # åˆ›å»º release
          gh release create "$RELEASE_TAG" \
            --title "$RELEASE_NAME" \
            --notes "åŸºäº QwenLM/qwen-code@$COMMIT_SHA çš„è‡ªåŠ¨æ„å»ºç‰ˆæœ¬

          ğŸ“¦ **åŒ…å«å¹³å°:**
          - Linux x64
          - Windows x64  
          - macOS x64 (Intel)
          - macOS ARM64 (Apple Silicon)
          
          ğŸš€ **ä½¿ç”¨æ–¹æ³•:**
          1. ä¸‹è½½å¯¹åº”å¹³å°çš„å¯æ‰§è¡Œæ–‡ä»¶
          2. è®¾ç½®ç¯å¢ƒå˜é‡: \`OPENAI_API_KEY\`, \`OPENAI_BASE_URL\`, \`OPENAI_MODEL\`
          3. ç›´æ¥è¿è¡Œ: \`./qwen-code\` æˆ– \`qwen-code.exe\`
          
          âš–ï¸ **è®¸å¯è¯è¯´æ˜:**
          - åŸå§‹é¡¹ç›®è®¸å¯è¯: Apache License 2.0
          - åŸå§‹é¡¹ç›®åœ°å€: https://github.com/QwenLM/qwen-code
          - ç‰ˆæƒå½’å±: Qwen Team, Alibaba Cloud
          
          âš ï¸ **é‡è¦å£°æ˜:** 
          - è¿™æ˜¯**éå®˜æ–¹**æ„å»ºç‰ˆæœ¬ï¼Œä¸ä»£è¡¨åŸä½œè€…ç«‹åœº
          - å¦‚é‡é—®é¢˜è¯·ä¼˜å…ˆä½¿ç”¨å®˜æ–¹ç‰ˆæœ¬
          - ä½¿ç”¨æ—¶è¯·éµå®ˆ Apache License 2.0 æ¡æ¬¾" \
            --repo "${{ github.repository }}" \
            $RELEASE_FILES

  notify:
    needs: [check-updates, build, release]
    runs-on: ubuntu-latest
    if: always() && needs.check-updates.outputs.should-build == 'true'
    
    steps:
      - name: é€šçŸ¥æ„å»ºç»“æœ
        run: |
          if [ "${{ needs.release.result }}" = "success" ]; then
            echo "âœ… æ„å»ºæˆåŠŸï¼æ–°ç‰ˆæœ¬å·²å‘å¸ƒ: auto-${{ needs.check-updates.outputs.latest-commit }}"
          else
            echo "âŒ æ„å»ºå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
          fi