# .github/workflows/auto-build.yml
name: è‡ªåŠ¨æ„å»º qwen-code å¯æ‰§è¡Œæ–‡ä»¶

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´æ—©ä¸Š 8 ç‚¹ï¼ˆUTC 0 ç‚¹ï¼‰è¿è¡Œ
    - cron: '0 0 * * *'
  workflow_dispatch: # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main ] # å½“ä¸»åˆ†æ”¯æœ‰æ¨é€æ—¶ä¹Ÿè§¦å‘

jobs:
  check-updates:
    runs-on: ubuntu-latest
    outputs:
      should-build: ${{ steps.check.outputs.should-build }}
      latest-commit: ${{ steps.check.outputs.latest-commit }}
    steps:
      - name: æ£€æŸ¥ä¸Šæ¸¸ä»“åº“æ˜¯å¦æœ‰æ›´æ–°
        id: check
        run: |
          # è·å–ä¸Šæ¸¸æœ€æ–° commit
          LATEST_COMMIT=$(curl -s https://api.github.com/repos/QwenLM/qwen-code/commits/main | jq -r '.sha[:7]')
          echo "latest-commit=$LATEST_COMMIT" >> $GITHUB_OUTPUT
          
          # æ£€æŸ¥æ˜¯å¦å·²ç»æ„å»ºè¿‡è¿™ä¸ªç‰ˆæœ¬
          if gh release view "auto-$LATEST_COMMIT" >/dev/null 2>&1; then
            echo "ç‰ˆæœ¬ $LATEST_COMMIT å·²å­˜åœ¨ï¼Œè·³è¿‡æ„å»º"
            echo "should-build=false" >> $GITHUB_OUTPUT
          else
            echo "å‘ç°æ–°ç‰ˆæœ¬ $LATEST_COMMITï¼Œå¼€å§‹æ„å»º"
            echo "should-build=true" >> $GITHUB_OUTPUT
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build:
    needs: check-updates
    if: needs.check-updates.outputs.should-build == 'true'
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: linux-x64
            ext: ''
          - os: windows-latest
            target: windows-x64
            ext: '.exe'
          - os: macos-latest
            target: macos-x64
            ext: ''
          - os: macos-14 # M1 macOS
            target: macos-arm64
            ext: ''
    
    runs-on: ${{ matrix.os }}
    
    steps:
      - name: å…‹éš†ä¸Šæ¸¸ä»“åº“
        uses: actions/checkout@v4
        with:
          repository: QwenLM/qwen-code
          ref: main
          
      - name: å¤åˆ¶è®¸å¯è¯æ–‡ä»¶
        run: |
          # å¤åˆ¶åŸå§‹è®¸å¯è¯å’Œç‰ˆæƒæ–‡ä»¶
          cp LICENSE ../
          if [ -f "NOTICE" ]; then cp NOTICE ../; fi
          if [ -f "COPYRIGHT" ]; then cp COPYRIGHT ../; fi
          
      - name: å®‰è£… Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest
          
      - name: å®‰è£…ä¾èµ–
        run: bun install
        
      - name: æ‰¾åˆ°å…¥å£æ–‡ä»¶
        id: entry
        run: |
          # æŸ¥æ‰¾å¯èƒ½çš„å…¥å£æ–‡ä»¶
          if [ -f "bundle/gemini.js" ]; then
            echo "entry=bundle/gemini.js" >> $GITHUB_OUTPUT
          elif [ -f "bin/qwen" ]; then
            echo "entry=bin/qwen" >> $GITHUB_OUTPUT
          elif [ -f "dist/index.js" ]; then
            echo "entry=dist/index.js" >> $GITHUB_OUTPUT
          else
            # ä» package.json è¯»å–
            MAIN=$(bun run --silent -e "console.log(require('./package.json').main || 'index.js')")
            echo "entry=$MAIN" >> $GITHUB_OUTPUT
          fi
        shell: bash
        
      - name: ä½¿ç”¨ Bun ç¼–è¯‘å¯æ‰§è¡Œæ–‡ä»¶
        run: |
          echo "ç¼–è¯‘å…¥å£æ–‡ä»¶: ${{ steps.entry.outputs.entry }}"
          bun build ${{ steps.entry.outputs.entry }} --compile --outfile qwen-code-${{ matrix.target }}${{ matrix.ext }}
          
      - name: éªŒè¯å¯æ‰§è¡Œæ–‡ä»¶
        run: |
          if [ "${{ matrix.os }}" = "windows-latest" ]; then
            ./qwen-code-${{ matrix.target }}.exe --version || echo "ç‰ˆæœ¬æ£€æŸ¥å¤±è´¥ï¼Œä½†æ–‡ä»¶å·²ç”Ÿæˆ"
          else
            ./qwen-code-${{ matrix.target }} --version || echo "ç‰ˆæœ¬æ£€æŸ¥å¤±è´¥ï¼Œä½†æ–‡ä»¶å·²ç”Ÿæˆ"
          fi
        shell: bash
        
      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: qwen-code-${{ matrix.target }}
          path: qwen-code-${{ matrix.target }}${{ matrix.ext }}
          retention-days: 30

  release:
    needs: [check-updates, build]
    runs-on: ubuntu-latest
    if: needs.check-updates.outputs.should-build == 'true'
    
    steps:
      - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        
      - name: åˆ›å»ºå‘å¸ƒ
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          COMMIT_SHA="${{ needs.check-updates.outputs.latest-commit }}"
          RELEASE_TAG="auto-$COMMIT_SHA"
          RELEASE_NAME="è‡ªåŠ¨æ„å»º - $COMMIT_SHA ($(date '+%Y-%m-%d'))"
          
          # åˆ›å»º release
          gh release create "$RELEASE_TAG" \
            --title "$RELEASE_NAME" \
            --notes "åŸºäº QwenLM/qwen-code@$COMMIT_SHA çš„è‡ªåŠ¨æ„å»ºç‰ˆæœ¬

          ğŸ“¦ **åŒ…å«å¹³å°:**
          - Linux x64
          - Windows x64  
          - macOS x64
          - macOS ARM64 (Apple Silicon)
          
          ğŸš€ **ä½¿ç”¨æ–¹æ³•:**
          1. ä¸‹è½½å¯¹åº”å¹³å°çš„å¯æ‰§è¡Œæ–‡ä»¶
          2. è®¾ç½®ç¯å¢ƒå˜é‡: \`OPENAI_API_KEY\`, \`OPENAI_BASE_URL\`, \`OPENAI_MODEL\`
          3. ç›´æ¥è¿è¡Œ: \`./qwen-code\` æˆ– \`qwen-code.exe\`
          
          âš–ï¸ **è®¸å¯è¯è¯´æ˜:**
          - åŸå§‹é¡¹ç›®è®¸å¯è¯: Apache License 2.0
          - åŸå§‹é¡¹ç›®åœ°å€: https://github.com/QwenLM/qwen-code
          - ç‰ˆæƒå½’å±: Qwen Team, Alibaba Cloud
          
          âš ï¸ **é‡è¦å£°æ˜:** 
          - è¿™æ˜¯**éå®˜æ–¹**æ„å»ºç‰ˆæœ¬ï¼Œä¸ä»£è¡¨åŸä½œè€…ç«‹åœº
          - å¦‚é‡é—®é¢˜è¯·ä¼˜å…ˆä½¿ç”¨å®˜æ–¹ç‰ˆæœ¬
          - ä½¿ç”¨æ—¶è¯·éµå®ˆ Apache License 2.0 æ¡æ¬¾" \
            --repo "${{ github.repository }}" \
            ../LICENSE \
            ../NOTICE \
            qwen-code-linux-x64/qwen-code-linux-x64 \
            qwen-code-windows-x64/qwen-code-windows-x64.exe \
            qwen-code-macos-x64/qwen-code-macos-x64 \
            qwen-code-macos-arm64/qwen-code-macos-arm64

  notify:
    needs: [check-updates, build, release]
    runs-on: ubuntu-latest
    if: always() && needs.check-updates.outputs.should-build == 'true'
    
    steps:
      - name: é€šçŸ¥æ„å»ºç»“æœ
        run: |
          if [ "${{ needs.release.result }}" = "success" ]; then
            echo "âœ… æ„å»ºæˆåŠŸï¼æ–°ç‰ˆæœ¬å·²å‘å¸ƒ: auto-${{ needs.check-updates.outputs.latest-commit }}"
          else
            echo "âŒ æ„å»ºå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
          fi